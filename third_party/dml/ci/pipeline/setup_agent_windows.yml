steps:
- powershell: |
    $Url = 'https://github.com/msys2/msys2-installer/releases/download/nightly-x86_64/msys2-base-x86_64-latest.sfx.exe'
    $DownloadPath = '$(Build.StagingDirectory)/msys2.exe'
    (New-Object System.Net.WebClient).DownloadFile($Url, $DownloadPath)
    & "$DownloadPath" -y
    & "msys64/usr/bin/bash" -lc ' '
    & "msys64/usr/bin/pacman.exe" --sync --needed --noconfirm git patch unzip
    echo "##vso[task.prependpath]$(Build.StagingDirectory)/msys64/usr/bin"
  displayName: Install MSYS2
  workingDirectory: $(Build.StagingDirectory)

- powershell: |
    $Url = 'https://github.com/bazelbuild/bazel/releases/download/0.24.1/bazel-0.24.1-windows-x86_64.exe'
    $DownloadPath = '$(Build.StagingDirectory)/bin/bazel.exe'
    $InstallDir = Split-Path $DownloadPath -Parent
    New-Item -Force -ItemType Directory $InstallDir
    (New-Object System.Net.WebClient).DownloadFile($Url, $DownloadPath)
    echo "##vso[task.prependpath]$InstallDir"
  displayName: Install Bazel
  workingDirectory: $(Build.StagingDirectory)

- powershell: |
    $Url = 'https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe'
    write-host "A"
    $DownloadPath = '$(Build.StagingDirectory)/miniconda.exe'
    write-host "B"
    (New-Object System.Net.WebClient).DownloadFile($Url, $DownloadPath)
    write-host "C"
    $InstallDir = '$(Build.StagingDirectory)/miniconda3'
    write-host "D"
    Start-Process $DownloadPath -ArgumentList '/NoRegistry=1', '/InstallationType=JustMe', '/RegisterPython=0', '/S', "/D=$InstallDir" -Wait
    write-host "E"
    & "$InstallDir/shell/condabin/conda-hook.ps1"
    write-host "F"
    conda create --name build python=$(vars.pyVersionMajorDotMinor) -y
    write-host "G"
    conda activate build
    write-host "H"
    echo "##vso[task.prependpath]$CONDA_PREFIX"
    write-host "I"
    echo "Using python at '$CONDA_PREFIX'"
  displayName: Install Python
  workingDirectory: $(Build.StagingDirectory)

- script: |
    pip install six numpy wheel
    pip install keras_applications==1.0.6 --no-deps
    pip install keras_preprocessing==1.0.5 --no-deps
  displayName: Install Python Packages